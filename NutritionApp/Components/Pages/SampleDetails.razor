@page "/sample-details/{Id}"
@using Microsoft.EntityFrameworkCore
@using SampleDatabaseBuilder.Services
@inject NavigationManager NavigationManager
@inject IDbContextFactory<SamplesContext> DbFactory
@rendermode InteractiveServer

<h1>Sample Details</h1>

@if (Sample != null)
{
	<div>
		<h3>General Information</h3>
		<table class="table table-striped table-sm table-custom">
			<tbody>
				<tr>
					<th>整合編號</th>
					<td>@Sample.Id</td>
				</tr>
				<tr>
					<th>樣品名稱</th>
					<td>@Sample.Name</td>
				</tr>
				<tr>
					<th>俗名</th>
					<td>@Sample.CommonName</td>
				</tr>
				<tr>
					<th>樣品英文名稱</th>
					<td>@Sample.EnglishName</td>
				</tr>
				<tr>
					<th>內容物描述</th>
					<td>@Sample.ContentDescription</td>
				</tr>
				<tr>
					<th>食品分類</th>
					<td>@Sample.FoodCatagory.Name</td>
				</tr>
				@if (Calories != null)
				{
					<tr>
						<th>熱量(@Calories.AnalysisItemInfo.Unit)</th>
						<td>@Calories.Value</td>
					</tr>
				}
				@if (CorrectedCalories != null)
				{
					<tr>
						<th>修正熱量(@CorrectedCalories.AnalysisItemInfo.Unit)</th>
						<td>@CorrectedCalories.Value</td>
					</tr>
				}
			</tbody>
		</table>
	</div>

	@if (CatagoryItems != null)
	{
		<h3>所有分析項</h3>

		@foreach (var pair in CatagoryItems)
		{
			<div>
				<!-- Display the category title -->
				<h3>@pair.Key</h3>

				<!-- Display the table for the category -->
				@if (PieData[pair.Key].Any())
				{
					<PieChart Labels="PieData[pair.Key].Keys.ToList()" Data="PieData[pair.Key].Values.ToList()" />
				}

				<table class="table table-striped table-sm table-custom">
					<thead>
						<tr>
							<th>分析項名稱</th>
							<th>單位</th>
							<th>每100g含量</th>
						</tr>
					</thead>
					<tbody>
						@foreach (var item in pair.Value)
						{
							<tr>
								<td>@item.AnalysisItemInfo.Name</td>
								<td>@item.AnalysisItemInfo.Unit</td>
								<td>@item.Value</td>
							</tr>
						}
					</tbody>
				</table>
			</div>
		}
	}
	else if (IsLoading)
	{
		<p>Loading...</p>
	}
	else
	{
		<p>Sample not found.</p>
	}

	<button @onclick="GoBack">Go Back</button>
}

@code {
	[Parameter] public string Id { get; set; }

	private Sample? Sample { get; set; }
	private Dictionary<string, AnalysisItem[]>? CatagoryItems { get; set; }
	private bool IsLoading { get; set; } = true;
	private AnalysisItem? Calories;
	private AnalysisItem? CorrectedCalories;
	private List<string> Labels = [];
	private List<double> Data = [];
	Dictionary<string, Dictionary<string, double>> PieData = [];

	protected override async Task OnInitializedAsync()
	{
		using var context = DbFactory.CreateDbContext();
		Sample = await context.Samples
		.Include(s => s.FoodCatagory)
		.Include(s => s.AnalysisItems)
		.ThenInclude(ai => ai.AnalysisItemInfo)
		.ThenInclude(aii => aii.AnalysisItemCatagoryInfo)
		.FirstOrDefaultAsync(s => s.Id == Id);

		if (Sample != null)
		{
			Calories = Sample.GetAnalysisItem("熱量");
			CorrectedCalories = Sample.GetAnalysisItem("修正熱量");

			CatagoryItems = Sample.AnalysisItems
			.GroupBy(x => x.AnalysisItemInfo.AnalysisItemCatagoryInfo.Name)
			.ToDictionary(g => g.Key, g => g.ToArray());

			PieData = CatagoryItems.ToDictionary(
			ci => ci.Key,
			ci =>
			{
				var items = from ai in ci.Value
							let value = ai.GetValueInMg()
							where value.HasValue && value > 0
							select new { ai.AnalysisItemInfo.Name, value.Value };
				var total = items.Sum(x => x.Value);
				if (total == 0)
					return [];
				return items.ToDictionary(
	x => x.Name,
	x => Math.Round(x.Value / total * 100, 2));
			});
		}

		IsLoading = false;
	}

	private void GoBack()
	{
		NavigationManager.NavigateTo("/sample-list", forceLoad: true);
	}
}
